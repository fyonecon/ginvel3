!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.mplayer=e():t.MPlayer=e()}(window,function(){return function(t){var e={};function i(r){if(e[r])return e[r].exports;var s=e[r]={i:r,l:!1,exports:{}};return t[r].call(s.exports,s,s.exports,i),s.l=!0,s.exports}return i.m=t,i.c=e,i.d=function(t,e,r){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:r})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var r=Object.create(null);if(i.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var s in t)i.d(r,s,function(e){return t[e]}.bind(null,s));return r},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e){function i(t,e={}){this.initParams(e),this.initAnalyser(e.analyser),this.initSource(t)}t.exports=i,i.prototype={initParams(t){let{index:e,auto:i}=t;this.handle={},this.index=e||0,this.auto=i||!0,this.options=t,this.delta=0,this.firstPlay=!0,this.ctx=new(window.AudioContext||window.webkitAudioContext),this.pause(),this.gain=this.ctx.createGain(),this.gain.connect(this.ctx.destination)},on(t,e){this.handle[t]?this.handle[t].push(e):this.handle[t]=[e]},off(t,e){e?this.handle[t]=this.handle[t].filter(t=>t!==e):delete this.handle[t]},emit(t){this.handle[t]&&this.handle[t].forEach(t=>t())},initSource(t){if(this.store=[],"string"==typeof t)this.index=0,this.store.push(t);else{if(!Array.isArray(t))throw new Error("expected resource is string url or Array url");this.store=t}this.initRequest()},initRequest(){let t=this.store[this.index];if("string"==typeof t)this.request(t).then(t=>this.initDecode(t)).catch(t=>{console.log(t),this.playNext()});else{if(!(t instanceof ArrayBuffer))throw new Error("expected resource is string url, ArrayBuffer");this.initDecode(t)}},initDecode(t){this.ctx.decodeAudioData(t).then(t=>{this.initBufferSource(t),this.setOptions(),this.auto&&this.play(),this.bindLoad()})},request(t){return new Promise((e,i)=>{let r=new XMLHttpRequest;r.open("GET",t,!0),r.responseType="arraybuffer",r.onreadystatechange=()=>{let{status:t,readyState:s,statusText:n}=r;4===s&&(t>=200&&t<300||304===t?e(r.response):i(`status: ${t}, ${n}`))},r.onerror=i.bind(this,"error"),r.ontimeout=i.bind(this,"request timerout！"),r.send()})},playPrev(){let t=this.store.length;this.loop&&!~--this.index&&(this.index+=t),this.reset()},playNext(){let t=this.store.length;this.loop&&(this.index=++this.index%t),this.reset()},reset(){this.pause(),this.firstPlay=!0,this.source.onended=null,this.source.stop(),this.initRequest()},initBufferSource(t){this.source=this.ctx.createBufferSource(),this.decodedData=t,this.source.buffer=this.decodedData,this.duration=this.source.buffer.duration,this.source.connect(this.analyser?this.analyser:this.gain),this.bindEnded()},bindLoad(){this.onload&&this.onload(),this.emit("load")},bindEnded(){this.source.onended=()=>{this.onended&&this.onended(),this.emit("ended")}},setOptions(t){let{loop:e,volume:i}=t||this.options;null!=e&&this.setLoop(e),null!=i&&this.setVolume(i)},initAnalyser(t){if(t){if("boolean"!=typeof t&&("object"!=typeof t||null===t))throw new Error("expected parameter is boolean or object");{this.analyser=this.ctx.createAnalyser();let e=t.size||1024;this.analyser.fftSize=e,this.analyser.connect(this.gain)}}},getData(){if(!this.analyser)return;let t=new Uint8Array(this.analyser.frequencyBinCount);return this.analyser.getByteFrequencyData(t),t},getCurrentTime(){return Math.min(this.ctx.currentTime-this.delta,this.duration)},play(){this.firstPlay&&this.start(0),"suspended"===this.ctx.state&&this.ctx.resume(),this.state="running"},pause(){"running"===this.ctx.state&&(this.ctx.suspend(),this.state="suspend")},toggle(){"running"===this.state?this.pause():this.play()},start(t){if("number"!=typeof t)throw new Error("expected parameter is number type");if(this.duration>=t&&t>=0)return this.delta=this.ctx.currentTime-t,this.firstPlay||(this.source.onended=null,this.source.stop(),this.initBufferSource(this.decodedData)),this.source.start(this.ctx.currentTime,t),this.state="running",void(this.firstPlay=!1);throw new Error(`value is out of range and expected range from 0 to ${this.duration}`)},setLoop(t){if("boolean"!=typeof t)throw new Error("expected parameter is boolean type");this.source.loop=t,this.loop=t},setVolume(t=1){if("number"!=typeof t)throw new Error("expected parameter is number type");if(t>=0&&t<=1)return this.gain.gain.value=t,void(this.volume=t);throw new Error("value is out of range and expected range from 0 to 1")}}}])});